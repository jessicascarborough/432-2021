---
title: "Real Title Goes Here"
author: "Jessica Scarborough"
date: "`r Sys.Date()`"
output:
  rmdformats::readthedown:
    highlight: kate
    number_sections: TRUE
    code_folding: show
---

```{r setup, echo = FALSE, cache=FALSE}
# This is the only chunk where you can use echo = FALSE
library(knitr)
options(max.print="75")
opts_chunk$set(comment=NA) 
opts_knit$set(width=75)
```

# R Packages and Setup {-}

```{r packages, message = FALSE}
library(knitr); library(rmdformats)
library(here); library(janitor); library(magrittr)
library(rms); library(broom)

# other packages as needed can go here

library(tidyverse)
```

# Data Source

This project utilizes data from the PLACES project 2020 release. The data contain county-level estimates of 27 health-related measures (5 on chronic disease-related unhealthy behaviors, 13 on health outcomes, and 9 on preventative service utilization). There are 3,142 counties included in the data set, covering the 50 states and District of Columbia of the United States. These data are provided by the Centers for Disease Control and Prevention (CDC), Division of Population Health, Epidemiology and Surveillance Branch. It is accessible to the general public and can be accessed by clicking [here](https://chronicdata.cdc.gov/500-Cities-Places/PLACES-Local-Data-for-Better-Health-County-Data-20/swc5-untb) [1].  

Using the 2017 and 2018 Behavioral Risk Factor Surveillance System (BRFSS) survey results, researchers utilized multilevel regression and post-stratification (MRP) to produce small area estimates of the 27 measures in each county. This approach is described by Zhang et al. (2014) [2] and Zhang et al. (2015) [3]. BRFSS is an annual telephone survey, which uses a standardized questionnaire to ask participants across the country about their health risk activities. It is sponsored by most divisions of the CDC, along with other federal agencies. These data are collected with the purpose of assisting organizations in the building and targeting of health promotion activities. 

# The Subjects

Each row in this data set represents a county within the United States. 

# Loading and Tidying the Data

We'll start by loading the PLACES data set from the `data` directory in our project directory. This file is completely unchanged from the original downloaded file from the [PLACES website](https://chronicdata.cdc.gov/500-Cities-Places/PLACES-Local-Data-for-Better-Health-County-Data-20/swc5-untb).

## Loading the Raw Data

```{r load_data}

counties_raw <- read.csv(here("data", "PLACES__Local_Data_for_Better_Health__County_Data_2020_release.csv"), na.strings = c(""))

?read.csv
unique(counties_raw$Data_Value_Unit)
```

<!-- regression:  -->
<!-- physical health not good ~ visits to the doctor for check up + arthritis + stroke + ckd -->

<!-- classifier:  -->
<!-- mental health ~ no leisure time + sleeping less than 7 hours + physical health not good + binge drinking -->

## Cleaning the Data

In this section, we'll work through taking the raw PLACSE 2020 dataset to a clean tibble that only contains our variables of interest. 

### Extracting variables of interest 

To start cleaning our dataset, we'll filter the raw dataset to extract the measures and data types that we are interested in. 

First, we'll remove any row that has a missing value for `LocationName`. Based on the population size for these rows, they appear to represent an aggregate for the entire United States. As such, they do not represent the county-level data we are assessing with this project. Then, we'll filter the `Data_Value_Type` variable to include only `Age-adjusted prevalence`, and we'll filter the `Measure` column to include only the following variables of interest: 

- `Physical health not good for >=14 days among adults aged >=18 years`
- `Visits to dentist or dental clinic among adults aged >=18 years`
- `Arthritis among adults aged >=18 years`
- `Stroke among adults aged >=18 years`
- `Chronic kidney disease among adults aged >=18 years`
- `Mental health not good for >=14 days among adults aged >=18 years`
- `No leisure-time physical activity among adults aged >=18 years`
- `Sleeping less than 7 hours among adults aged >=18 years`
- `Binge drinking among adults aged >=18 years`

Additionally, we'll use mutate to create a new column, `CountyState_ID`, which will serve as the unique identifier for each entry, using `paste` to combine the county name (`LocationName`) and state abbreviation (`StateAbbr`) variables.

```{r p1_extract_data}

counties_clean <- counties_raw %>%
  filter(!(is.na(LocationName))) %>%
  filter(Data_Value_Type == "Age-adjusted prevalence") %>%
  filter(Measure %in% c("Physical health not good for >=14 days among adults aged >=18 years", 
                        "Visits to dentist or dental clinic among adults aged >=18 years",
                        "Arthritis among adults aged >=18 years",
                        "Stroke among adults aged >=18 years",
                        "Chronic kidney disease among adults aged >=18 years",
                        "Mental health not good for >=14 days among adults aged >=18 years",
                        "No leisure-time physical activity among adults aged >=18 years",
                        "Sleeping less than 7 hours among adults aged >=18 years",
                        "Binge drinking among adults aged >=18 years")) %>%
  mutate(CountyState_ID = paste(LocationName, StateAbbr, sep = "-"))



```

### Formatting tibble

Next, we'll adjust the format of the tibble so that each row is a single county, while each column is a metric of interest. To do this, we'll use `pivot_wider` so that each unique `Measure` is a column, each row is a unique `CountyState_ID`, and the data are from `Data_Value`. Here, we'll also confirm that the `CountyState_ID` is unique for each row by showing that the number of rows in the tibble is the same as the number of unique values in the `CountyState_ID` column. 


```{r p1_format_data}

counties_clean <- counties_clean %>%
  pivot_wider(id_cols = CountyState_ID, names_from = Measure, values_from = Data_Value)


paste("Number of rows:", nrow(counties_clean))
paste("Number of unique CountyState_ID rows:", length(unique(counties_clean$CountyState_ID)))

```


### Shorten column names

Let's shorten the column names for ease of use and readability. They will be adjusted as follows:

- `Physical health not good for >=14 days among adults aged >=18 years` --> `Poor_Physical_Health`
- `Visits to dentist or dental clinic among adults aged >=18 years` --> `Dentist_Visit`
- `Arthritis among adults aged >=18 years` --> `Arthritis`
- `Stroke among adults aged >=18 years` --> `Stroke`
- `Chronic kidney disease among adults aged >=18 years` --> `CKD`
- `Mental health not good for >=14 days among adults aged >=18 years` --> `Poor_Mental_Health`
- `No leisure-time physical activity among adults aged >=18 years` --> `No_Leisure_Exer`
- `Sleeping less than 7 hours among adults aged >=18 years` --> `Less_Sleep`
- `Binge drinking among adults aged >=18 years` --> `Binge_Drinking`

```{r p1_adj_colnames}

colnames(counties_clean) <- c("CountyState_ID", "Poor_Physical_Health", "Dentist_Visit", "Arthritis", "Stroke", "CKD", "Poor_Mental_Health", "No_Leisure_Exer", "Less_Sleep", "Binge_Drinking")

```
### Convert `Poor_Mental_Health`, `Dentist_Visit`, and `No_Leisure_Exercise` into categorical variables

Since all of our variables are continuous, we'll need to convert a few of them into categorical to meet the requirements of this assignment. Using `mutate`, we'll convert `Poor_Mental_Health` into a binary variable called `Poor_Mental_Health_Binary`, while `Dentist_Visit` and `No_Leisure_Exer` will be converted into ordered categorical variables called `Dentist_Visit_Quartile` and `No_Leisure_Exer_Quintile`, respectively. `Poor_Mental_Health_Binary` will be categorized based on counties that are above and below the median value for the `Poor_Mental_Health` variable. `Dentist_Visit_Quartile` will be based on being in the first, second, third, or fourth quartile of the `Dentist_Visit` variable. `No_Leisure_Exer_Quintile` will be based on being in the first, second, third, fourth, or fifth quintile of the `No_Leisure_Exer`variable. These three new variables will be converted to ordered factors. 

We'll take a quick look at the new variables to ensure that our code accomplished what we expected it to. Seeing that it does, we'll remove the continuous `Dentist_Visit` and `No_Leisure_Exer` variables, because they won't be used in our future analysis.

```{r p1_convert_factor}


counties_clean <- counties_clean %>%
  mutate(Poor_Mental_Health_Binary = case_when(Poor_Mental_Health < median(Poor_Mental_Health) ~ 0,
                                               Poor_Mental_Health >= median(Poor_Mental_Health) ~ 1),
         Dentist_Visit_Quartile = case_when(Dentist_Visit < quantile(Dentist_Visit, 0.25) ~ 1,
                                            Dentist_Visit >= quantile(Dentist_Visit, 0.25) & 
                                              Dentist_Visit < quantile(Dentist_Visit, 0.5)  ~ 2,
                                            Dentist_Visit >= quantile(Dentist_Visit, 0.5) & 
                                              Dentist_Visit < quantile(Dentist_Visit, 0.75)  ~ 3,
                                            Dentist_Visit >= quantile(Dentist_Visit, 0.75) ~ 4),
         No_Leisure_Exer_Quintile = case_when(No_Leisure_Exer < quantile(No_Leisure_Exer, 0.2) ~ 1,
                                              No_Leisure_Exer >= quantile(No_Leisure_Exer, 0.2) &
                                                No_Leisure_Exer < quantile(No_Leisure_Exer, 0.4) ~ 2,
                                              No_Leisure_Exer >= quantile(No_Leisure_Exer, 0.4) &
                                                No_Leisure_Exer < quantile(No_Leisure_Exer, 0.6) ~ 3,
                                              No_Leisure_Exer >= quantile(No_Leisure_Exer, 0.6) &
                                                No_Leisure_Exer < quantile(No_Leisure_Exer, 0.8) ~ 4,
                                              No_Leisure_Exer >= quantile(No_Leisure_Exer, 0.8) ~ 5)) %>%
  mutate(Poor_Mental_Health_Binary = factor(Poor_Mental_Health_Binary, ordered = TRUE),
         Dentist_Visit_Quartile = factor(Dentist_Visit_Quartile, ordered = TRUE),
         No_Leisure_Exer_Quintile = factor(No_Leisure_Exer_Quintile, ordered = TRUE))


counties_clean$No_Leisure_Exer_Quintile


counties_clean %>%
  group_by(Poor_Mental_Health_Binary) %>%
  summarise(n = length(Poor_Mental_Health),
            min = min(Poor_Mental_Health),
            max = max(Poor_Mental_Health))

counties_clean %>%
  group_by(Dentist_Visit_Quartile) %>%
  summarise(n = length(Dentist_Visit),
            min = min(Dentist_Visit),
            max = max(Dentist_Visit))

counties_clean %>%
  group_by(No_Leisure_Exer_Quintile) %>%
  summarise(n = length(No_Leisure_Exer),
            min = min(No_Leisure_Exer),
            max = max(No_Leisure_Exer))


counties_clean <- counties_clean %>%
  select(-c(Dentist_Visit, No_Leisure_Exer))


```

### Subsampling

Our last step will be sampling the data to ensure that there are no more than 1200 rows. We are performing this step last, because we wanted to ensure that the `Poor_Mental_Health_Binary`, `Dentist_Visit_Quartile`, `No_Leisure_Exer_Quintile` were categorized based on their original, continuous value's relationship (e.g. above/below the median) to the entire dataset, not just the subsampling. We'll use `sample_n` from the `dpylr` package to choose 1200 counties without replacement.

```{r p1_sampling}

counties_sample <- counties_clean %>%
  sample_n(size = 1200, replace = FALSE)


```



# The Tidy Tibble

## Listing the Tibble

Let's take a look at our tidy tibble. 

```{r p1_list_tbl}

counties_sample

```
## Size and Identifiers

Do what we asked you to do in the instructions.

## Saving the R data set

Now, save your tibble as an R data set (.Rds file, which you'll also provide to us.)

# The Code Book

See the instructions and be sure that your code book includes all necessary elements.

## Defining the Variables

Here, to help you get started, is the example from the instructions.

Variable | Role | Type | Description
-------- | ---- | ---- | -----------------
`subjectID` | identifier | - | character code for subjects
`sysbp` | outcome | quant | Most Recent Systolic Blood Pressure, in mm Hg
`statin` | input | 2-cat | Has a current statin prescription? (Yes or No)


## Numerical Description

Here's where you would run `describe` from `Hmisc`.

# Linear Regression Plans

## My Quantitative Outcome

Follow the instructions.

## My Planned Predictors (Linear Model)

Follow the instructions.

# Logistic Regression Plans

## My Binary Outcome

Follow the instructions.

## My Planned Predictors (Logistic Model)

Follow the instructions.

# Affirmation 

I am certain that it is completely appropriate for these data to be shared with anyone, without any conditions. There are no concerns about privacy or security.

# References

1. PLACES Project. Centers for Disease Control and Prevention. Accessed [2021/02/16]. https://www.cdc.gov/places
2. Zhang, X., Holt, J. B., Lu, H., Wheaton, A. G., Ford, E. S., Greenlund, K. J., & Croft, J. B. (2014). Multilevel regression and poststratification for small-area estimation of population health outcomes: a case study of chronic obstructive pulmonary disease prevalence using the behavioral risk factor surveillance system. *American journal of epidemiology*, 179(8), 1025-1033.
3. Zhang, X., Holt, J. B., Yun, S., Lu, H., Greenlund, K. J., & Croft, J. B. (2015). Validation of multilevel regression and poststratification methodology for small area estimation of health indicators from the behavioral risk factor surveillance system. *American journal of epidemiology*, 182(2), 127-137.


# Session Information

```{r}
xfun::session_info()
```

